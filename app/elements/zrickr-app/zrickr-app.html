<link rel="import" href="../../bower_components/polymer/polymer.html">
<!-- Handlers -->
<link rel="import" href="../../elements/zrickr-collection/zrickr-collection.html">
<link rel="import" href="../../elements/zrickr-object/zrickr-object.html">
<link rel="import" href="../../elements/zrickr-route/zrickr-route.html">
<!-- Main view -->
<link rel="import" href="zrickr-app-view.html">
<!-- Possible views at one moment -->
<link rel="import" href="../../elements/zrickr-collection/zrickr-collection-new.html">
<link rel="import" href="../../elements/zrickr-profile/zrickr-profile.html">
<link rel="import" href="../../elements/zrickr-object/zrickr-object-new.html">
<link rel="import" href="../../elements/zrickr-object/zrickr-object-list.html">
<link rel="import" href="../../elements/zrickr-object/zrickr-object-view.html">

<!--
`<zrickr-app>` a handler to manage the main actions of the app

Example:

    <zrickr-app></zrickr-app>

@element zrickr-app
@demo demo/index.html
-->

<dom-module id="zrickr-app">
  <template>
    <zrickr-route
      id="zrickrRoute"
      path="{{path}}"
      page-route-data="{{pageRouteData}}"
      id-route-data="{{idRouteData}}"
      sub-id-route-data="{{subIdRouteData}}">
    </zrickr-route>
    <zrickr-app-view
      id="zrickrAppView"
      auth='{{auth}}'
      items='{{items}}'
      position-drawer='left'>
    </zrickr-app-view>
    <zrickr-collection
      id="collectionHandler"
      location="[[auth.location]]"
      collections="{{items}}">
    </zrickr-collection>
    <zrickr-object
      id="objectHandler"
      location="[[auth.location]]">
    </zrickr-object>
  </template>
</dom-module>

<script>
(function() {
  'use strict';

  Polymer({
    is: 'zrickr-app',

    properties: {
      path:  {
        type: String
      },
      pageRouteData:  {
        type: Object
      },
      idRouteData:  {
        type: Object
      },
      subIdRouteData:  {
        type: Object
      },
      /**
       * Authentication and backend information
       */
      auth: {
        type: Object
      },
      items: {
        type: Array
      }
    },

    listeners: {
      'add-item-tapped': '_newItemProcess',
      'add-item': '_addItem',
      'home-tapped': '_viewItems',
      'item-tapped': '_viewItem',
      'view-item-tapped': '_viewItem',
      'edit-item-tapped': '_editItem',
      'delete-item-tapped': '_deleteItem',
      'edit-profile-tapped': '_editProfile',
      'add-object-tapped': '_newObjectProcess',
      'add-object': '_addObject',
      'view-object-tapped': '_viewObject'
    },

    //https://www.polymer-project.org/1.0/toolbox/routing
    observers: [
      '_pathChanged(path)',
      '_pageRouteChanged(pageRouteData.page)',
      '_idRouteChanged(idRouteData.id)',
      '_subIdRouteChanged(subIdRouteData.id)'
    ],

    _shapeURL(...paths) {
      this.$.zrickrRoute.shapePath(...paths);
    },

    _hasSubroute(level) {
      if (this.$.zrickrRoute.noSubroute(level)) {
        return false;
      }
      return true;
    },

    _showViewItems(headerTitle) {
      this.$.zrickrAppView.showItems(headerTitle);
    },

    _showViewElement(elementName, headerTitle) {
      let element = document.createElement(elementName);
      return this.$.zrickrAppView.showElement(element, headerTitle);
    },

    _showViewTempElement(elementName) {
      let element = document.createElement(elementName);
      this.$.zrickrAppView.showTempElement(element);
    },

    _pathChanged(path) {
      if (!this._hasSubroute(0)) {
        this._shapeURL('items');
      }
      if (this._hasSubroute(3)) {
        this._showViewElement('zrickr-profile', "RUTA NO ENCONTRADA");
        return;
      }
    },

    _pageRouteChanged(page) {
      if (!this._hasSubroute(1)) {
        switch (page) {
          case 'items':
            this._showViewItems('My Collections jiji');
            break;
          case 'profile':
            this._showViewElement('zrickr-profile','User Profile');
            break;
          default:
            //TODO: error page
            this._showViewElement('zrickr-profile', "RUTA NO ENCONTRADA");
        }
      }
    },

    _idRouteChanged(id) {
      if (id && !this._hasSubroute(2)) {
        let page = this.pageRouteData.page;
        switch (page) {
          case 'items':
            let itemId = id;
            let itemNamePromise = this.$.collectionHandler.getNameById(itemId);
            itemNamePromise
              .then((itemName) => {
                let zrickrObjectList =
                  this._showViewElement('zrickr-object-list', itemName);
                zrickrObjectList.item = {
                  'id': itemId,
                  'name': itemName
                };
                zrickrObjectList.itemId = itemId;
              })
              .catch((message) => {
                this._showViewElement('zrickr-profile', message);
              });
            break;
          default:
            //TODO: error page
            this._showViewElement('zrickr-profile', "RUTA NO ENCONTRADA");
        }
      }
    },

    _subIdRouteChanged(id) {
      if (id && !this._hasSubroute(3)) {
        let page = this.pageRouteData.page;
        let subPage = this.idRouteData.id;
        switch (page) {
          case 'items':
            let itemId = subPage;
            let objectId = id;
            let itemNamePromise = this.$.collectionHandler.getNameById(itemId);
            itemNamePromise
            .then((itemName) => {
              console.log(itemName);
              let zrickrObjectView =
                this._showViewElement('zrickr-object-view',
                                     itemName + ': ' + objectId);
              zrickrObjectView.item = {
                'id': objectId,
                'itemId': itemId
              };
            })
            .catch((message) => {
              this._showViewElement('zrickr-profile', message);
            });
            break;
          default:
            //TODO: error page
            this._showViewElement('zrickr-profile', "RUTA NO ENCONTRADA");
        }
      }
      else {
      }
    },

    _editProfile() {
      this._shapeURL('profile');
    },

    _viewItems() {
      this._shapeURL('items');
    },

    /**
    * Fires when the user wants to view a item
    */
    _viewItem(event) {
      let item = event.detail;
      let itemId = this.$.collectionHandler.getId(item);
      this._shapeURL('items', itemId);
    },

    _viewObject(event) {
      let object = event.detail;
      let itemId = object.itemId;
      let itemName = this.$.collectionHandler.getNameById(itemId);
      let objectId = this.$.objectHandler.getId(object);
      this._shapeURL('items', itemId, objectId);
    },

    /**
     * Fired when the user taps on add a new item in drawer. Add
     * the new process of collecion creation
     */
    _newItemProcess() {
      this._showViewTempElement('zrickr-collection-new');
      this.$.zrickrAppView.closeDrawer();
    },

    /**
     * Fires when the process of creation has finished
     */
    _addItem(event) {
      let item = event.detail;
      this.$.collectionHandler.add(item);
    },

    /**
     * Fires when the user wants to edit a item
     */
    _editItem(event) {
      let item = event.detail;
    },

    /**
     * Fires when the user wants to delete a item
     */
    _deleteItem(event) {
      let item = event.detail;
    },

    /**
     * Fires when the user wants to add an object on a item
     */
    _newObjectProcess(event) {
      let object = event.detail;
      let itemId = object.itemId;
      let itemName = object.itemName;
      let zrickrObjectNew =
        this._showViewElement('zrickr-object-new',
                             'New ' + itemName + ' object');
      zrickrObjectNew.itemId = itemId;
    },

    /**
     * Fires when the user finish the object creation process
     */
    _addObject(event) {
      let object = event.detail;
      this.$.objectHandler.add(object);
      let itemId = object.itemId;
      let itemName = this.$.collectionHandler.getNameById(itemId);
      let zrickrObjectList =
        this._showViewElement('zrickr-object-list', itemName);
      zrickrObjectList.item = {
        'id': itemId,
        'name': itemName
      };
    }
  });
})();
</script>
