<link rel="import" href="../../bower_components/polymer/polymer.html">
<!-- Handlers -->
<link rel="import" href="../../elements/zrickr-backend/zrickr-backend-collection.html">
<link rel="import" href="../../elements/zrickr-route/zrickr-route.html">
<!-- Main view -->
<link rel="import" href="zrickr-app-view.html">
<!-- Possible views at one moment -->
<link rel="import" href="../../elements/zrickr-collection/zrickr-collection-new.html">
<link rel="import" href="../../elements/zrickr-loading/zrickr-loading.html">
<link rel="import" href="../../elements/zrickr-profile/zrickr-profile.html">
<link rel="import" href="../../elements/zrickr-object/zrickr-object-new.html">
<link rel="import" href="../../elements/zrickr-object/zrickr-object-list.html">
<link rel="import" href="../../elements/zrickr-object/zrickr-object-view.html">

<!--
`<zrickr-app>` a handler to manage the main actions of the app

Example:

    <zrickr-app></zrickr-app>

@element zrickr-app
@demo demo/index.html
-->

<dom-module id="zrickr-app">
  <template>
    <zrickr-route
      id="zrickrRoute"
      path="{{path}}"
      page-route-data="{{pageRouteData}}"
      id-route-data="{{idRouteData}}"
      sub-id-route-data="{{subIdRouteData}}">
    </zrickr-route>
    <zrickr-app-view
      id="zrickrAppView"
      auth='{{auth}}'
      items='{{items}}'
      position-drawer='left'
      loading-items='{{loadingItems}}'>
    </zrickr-app-view>
    <zrickr-backend-collection
      id="collectionHandler"
      app='[[backendApp]]'
      location="[[auth.location]]"
      sublocation="collections"
      name-collection="LALALALA"
      loading='{{loadingItems}}'
      data="{{items}}">
    </zrickr-backend-collection>
    <zrickr-backend-collection
      id="objectHandler"
      app='[[backendApp]]'
      location="[[auth.location]]"
      sublocation="objects"
      has-id
      name-collection="LALALALA2"
      data="{{objects}}">
    </zrickr-backend-collection>
  </template>
</dom-module>

<script>
(function() {
  'use strict';

  Polymer({
    is: 'zrickr-app',

    properties: {
      /**
       *  Current backend connection
       */
      backendApp: {
        type: Object,
        readonly: true
      },
      /**
       * Current path of the URL
       */
      path: {
        type: String
      },
      /**
       * Information about the first level route
       */
      pageRouteData:  {
        type: Object
      },
      /**
       * Information about the second level route
       */
      idRouteData:  {
        type: Object
      },
      /**
       * Information about the third level route
       */
      subIdRouteData:  {
        type: Object
      },
      /**
       * Authentication and backend information
       */
      auth: {
        type: Object
      },
      /**
       * Array of app items
       */
      items: {
        type: Array
      },
      /**
       * Array of objects of a item
       */
       objects: {
         type: Array
       }
    },

    listeners: {
      'add-item-tapped': '_newItemProcess',
      'add-item': '_addItem',
      'home-tapped': '_viewItems',
      'item-tapped': '_viewItem',
      'view-item-tapped': '_viewItem',
      'edit-item-tapped': '_editItem',
      'delete-item-tapped': '_deleteItem',
      'edit-profile-tapped': '_editProfile',
      'add-object-tapped': '_newObjectProcess',
      'add-object': '_addObject',
      'view-object-tapped': '_viewObject'
    },

    //https://www.polymer-project.org/1.0/toolbox/routing
    observers: [
      '_pathChanged(path)',
      '_pageRouteChanged(pageRouteData.page)',
      '_idRouteChanged(idRouteData.id, objects)',
      '_subIdRouteChanged(subIdRouteData.id, objects)'
    ],

    /**
     * Form the path of the URL with the arguments
     * @param  {Strings} ...paths Strings routes separated by comas
     */
    _shapeURL(...paths) {
      this.$.zrickrRoute.shapePath(...paths);
    },

    /**
     * Indicate if the level of the route path has more subroutes after
     * (ie. current_path ='/items/123', _hasSubroute(1)=>true,
     * _hasSubroute(2)=>false).
     * @param  {Number}  level Level of the route path. If it's 0 the path
     * would be '/'
     * @return {Boolean}       True if the level route path has more subroutes
     */
    _hasSubroute(level) {
      if (this.$.zrickrRoute.subroutePrefix(level)) {
        return false;
      }
      return true;
    },

    /**
     * Show the items in the main content of the view element
     * @param  {String} headerTitle Title of the header content
     */
    _showViewItems(headerTitle) {
      this.$.zrickrAppView.showItems(headerTitle);
    },

    /**
     * Show an element in the main content of the view element
     * @param  {String} elementName Element name to show
     * @param  {String} headerTitle Title of the header content
     * @return {Object}             The element modified with the new
     * attributes
     */
    _showViewElement(elementName, headerTitle, properties) {
      let element = document.createElement(elementName);
      if (properties) {
        Object.keys(properties).forEach((key) => {
          element[key] = properties[key];
        });
      }
      return this.$.zrickrAppView.showElement(element, headerTitle);
    },

    /**
     * Show a temporary element (ie. a dialog) in the main content of the view
     * element
     * @param  {String} elementName Element name to show
     */
    _showViewTempElement(elementName) {
      let element = document.createElement(elementName);
      this.$.zrickrAppView.showTempElement(element);
    },

    /**
     * Fired when the path changes. This function process the route paths with
     * level is less than 1 ('/') and level is greater than 3
     * ('/r1/r2/r3/r4[/..]')
     * @param  {String} path Current route path
     */
    _pathChanged(path) {
      if (!this._hasSubroute(0)) {
        this._shapeURL('items');
      }
      if (this._hasSubroute(3)) {
        this._showViewElement('zrickr-profile', "RUTA NO ENCONTRADA");
        return;
      }
    },

    /**
     * Fired when the prefix of the route path with level 1 changes
     * @param  {String} path The prefix of the route path with level 1
     * (ie. current_path='/items/123', page='items')
     */
    _pageRouteChanged(page) {
      if (!this._hasSubroute(1)) {
        switch (page) {
          case 'items':
            this._showViewItems('My Collections jiji');
            break;
          case 'profile':
            this._showViewElement('zrickr-profile','User Profile');
            break;
          default:
            //TODO: error page
            this._showViewElement('zrickr-profile', "RUTA NO ENCONTRADA");
        }
      }
    },

    /**
     * Fired when the prefix of the route path with level 2 changes.
     * It fires when objects change too.
     * @param  {String} id The prefix of the route path with level 2
     * (ie. current_path='/items/123', id='123')
     */
    _idRouteChanged(id, objects) {
      if (id && !this._hasSubroute(2)) {
        let page = this.pageRouteData.page;
        switch (page) {
          case 'items':
            let collectionHandler = this.$.collectionHandler;
            let objectHandler = this.$.objectHandler;
            let itemId = id;
            /*
             * Objects array have not changed yet (only id change)
             * The second condition indicate id item of the objects changes too
             * (i.e. the path changes from "/items/123" to "/items/123/")
             */
            if (!objectHandler.loading && objectHandler.dataId != itemId) {
              objectHandler.startLoading();
              this._showViewElement('zrickr-loading', '', {'whatLoading': 'collections'});
              objectHandler.dataId = itemId; // here objects change
            }
            /*
             * Objects array have changed (notice loading of them is true yet)
             * or dataId remains the same
             */
            else {
              let itemName = collectionHandler.getNameById(itemId);
              if (itemName) {
                let properties = {};
                properties.objects = objects;
                properties.item = {
                  'id': itemId,
                  'name': itemName
                };
                let zrickrObjectList =
                  this._showViewElement('zrickr-object-list', itemName, properties);
              }
              else {
                this._showViewElement('zrickr-object-list', 'ITEM NO ENCONTRADO');
              }
              objectHandler.stopLoading();
            }
            break;
          default:
            //TODO: error page
            this._showViewElement('zrickr-profile', "RUTA NO ENCONTRADA");
        }
      }
    },

    /**
     * Fired when the prefix of the route path with level 3 changes
     *
     * @param  {String} path The prefix of the route path with level 3
     * (ie. current_path='/items/123/fgh', id='fgh')
     */
    _subIdRouteChanged(id, objects) {
      if (id && !this._hasSubroute(3)) {
        let page = this.pageRouteData.page;
        let subPage = this.idRouteData.id;
        switch (page) {
          case 'items':
            let collectionHandler = this.$.collectionHandler;
            let objectHandler = this.$.objectHandler;
            let itemId = subPage;
            let objectId = id;
            if (!objectHandler.loading && objectHandler.dataId != itemId) {
              objectHandler.startLoading();
              this._showViewElement('zrickr-loading', '', {'whatLoading': 'objects'});
              objectHandler.dataId = itemId; // here objects change
            }
            else {
              let item = collectionHandler.getDocument(itemId);
              if (item) {
                let itemName = collectionHandler.getName(item);
                let object = objectHandler.getDocument(objectId);
                if (object) {
                  let properties = {};
                  properties.objects = objects;
                  properties.item = {
                    'id': itemId,
                    'name': itemName
                  };
                  let zrickrObjectView =
                    this._showViewElement('zrickr-object-view',
                                          itemName + ': ' + objectId,
                                          properties);
                  zrickrObjectView.item = {
                    'id': objectId,
                    'itemId': itemId
                  };
                }
                else {
                  this._showViewElement('zrickr-profile', "OBJECT NO ENCONTRADO");
                }
              }
              else {
                this._showViewElement('zrickr-profile', "ITEM NO ENCONTRADO");
              }
              objectHandler.stopLoading();
            }
            break;
          default:
            //TODO: error page
            this._showViewElement('zrickr-profile', "RUTA NO ENCONTRADA");
        }
      }
      else {
      }
    },

    /**
     * Fired when the user wants to view the profile page
     */
    _editProfile() {
      this._shapeURL('profile');
    },

    /**
     * Fired when the user wants to view all the items
     */
    _viewItems() {
      this._shapeURL('items');
    },

    /**
     * Fired when the user wants to view a item information
     */
    _viewItem(event) {
      let item = event.detail;
      let itemId = this.$.collectionHandler.getId(item);
      this._shapeURL('items', itemId);
    },

    /**
     * Fired when the user wants to view a object information
     */
    _viewObject(event) {
      let object = event.detail;
      let itemId = object.item.id;
      let itemName = this.$.collectionHandler.getNameById(itemId);
      let objectId = this.$.objectHandler.getId(object);
      this._shapeURL('items', itemId, objectId);
    },

    /**
     * Fired when the user taps on adding a new item. Add
     * the new process of collecion creation
     */
    _newItemProcess() {
      this._showViewTempElement('zrickr-collection-new');
      this.$.zrickrAppView.closeDrawer();
    },

    /**
     * Fired when the process of creation has finished
     */
    _addItem(event) {
      let item = event.detail;
      this.$.collectionHandler.add(item);
    },

    /**
     * Fires when the user wants to edit a item
     */
    _editItem(event) {
      let item = event.detail;
    },

    /**
     * Fires when the user wants to delete a item
     */
    _deleteItem(event) {
      let item = event.detail;
    },

    /**
     * Fires when the user wants to add an object on a item
     */
    _newObjectProcess(event) {
      let object = event.detail;
      let item = object.item;
      let zrickrObjectNew =
        this._showViewElement('zrickr-object-new',
                             'New ' + item.name + ' object');
      zrickrObjectNew.item = item;
    },

    /**
     * Fires when the user finish the object creation process
     */
    _addObject(event) {
      let object = event.detail;
      console.log(object);
      let itemId = object.item.id;
      let itemName = object.item.name;
      this.$.objectHandler.dataId = object.item.id;
      this.$.objectHandler.add(object);
      let zrickrObjectList =
        this._showViewElement('zrickr-object-list', itemName);
      zrickrObjectList.item = {
        'id': itemId,
        'name': itemName
      };
    }
  });
})();
</script>
