<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-drawer-panel/paper-drawer-panel.html">
<link rel="import" href="../../bower_components/paper-scroll-header-panel/paper-scroll-header-panel.html">
<link rel="import" href="../../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../../bower_components/app-route/app-route.html">
<link rel="import" href="../../bower_components/app-route/app-location.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../styles/shared-styles.html">
<!-- Main view elements -->
<link rel="import" href="../../elements/zrickr-drawer/zrickr-drawer-toolbar.html">
<link rel="import" href="../../elements/zrickr-drawer/zrickr-drawer-content.html">
<link rel="import" href="../../elements/zrickr-main/zrickr-main-toolbar.html">
<link rel="import" href="../../elements/zrickr-main/zrickr-main-content.html">
<!-- Handlers of items and objects -->
<link rel="import" href="../../elements/zrickr-collection/zrickr-collection.html">
<link rel="import" href="../../elements/zrickr-object/zrickr-object.html">
<!-- Possible views at one moment -->
<link rel="import" href="../../elements/zrickr-collection/zrickr-collection-new.html">
<link rel="import" href="../../elements/zrickr-profile/zrickr-profile.html">
<link rel="import" href="../../elements/zrickr-object/zrickr-object-new.html">
<link rel="import" href="../../elements/zrickr-object/zrickr-object-list.html">
<link rel="import" href="../../elements/zrickr-object/zrickr-object-view.html">

<!--
`<zrickr-app>` provides a web main structure with a drawer
and a main content

Example:

    <zrickr-app></zrickr-app>

@element zrickr-app
@demo demo/index.html
-->

<dom-module id="zrickr-app">
  <style include="iron-flex iron-flex-alignment shared-styles">
    :host {
      display: block;
    }
    #mainPanel {
      background: var(--main-panel-background-color, --primary-background-color);
      height: 100%;
    }
    #drawer {
      background: var(--drawer-background-color, --primary-background-color);
      border-right: 1px solid var(--primary-color);
    }
    #main {
      background: var(--main-background-color, --primary-background-color);
    }
  </style>

  <template>
    <zrickr-collection
      id="collectionHandler"
      location="[[auth.location]]"
      collections="{{items}}">
    </zrickr-collection>
    <zrickr-object
      id="objectHandler"
      location="[[auth.location]]">
    </zrickr-object>

    <app-location
      use-hash-as-path
      route="{{route}}"
      path="{{path}}">
    </app-location>
    <app-route
      id="pageRoute"
      route="{{route}}"
      pattern="/:page"
      data="{{pageRouteData}}"
      tail="{{pageSubrouteData}}"
      active="{{pageRouteActive}}">
    </app-route>
    <app-route
      id="idRoute"
      route="{{pageSubrouteData}}"
      pattern="/:id"
      data="{{idRouteData}}"
      tail="{{idSubrouteData}}"
      active="{{idRouteActive}}">
    </app-route>
    <app-route
      id="subIdRoute"
      route="{{idSubrouteData}}"
      pattern="/:id"
      data="{{subIdRouteData}}"
      tail="{{subIdSubrouteData}}"
      active="{{subIdRouteActive}}">
    </app-route>

    <paper-drawer-panel
      id="mainPanel"
      force-narrow>
      <paper-scroll-header-panel id="drawer" fixed drawer>
        <zrickr-drawer-toolbar
          class="paper-header"
          id="drawerToolbar">
        </zrickr-drawer-toolbar>
        <zrickr-drawer-content
          items="[[items]]"
          primary-catalog-menu-name="My Collections"
          secondary-catalog-menu-name="My Shared Collections"
          item-name="collection"
          object-name="object"
          id="drawerContent">
        </zrickr-drawer-content>
      </paper-scroll-header-panel>
      <paper-scroll-header-panel id="main" fixed main>
        <zrickr-main-toolbar
          auth={{auth}}
          class="paper-header"
          id="mainToolbar">
        </zrickr-main-toolbar>
        <zrickr-main-content
          auth="{{auth}}"
          items="{{items}}"
          id="mainContent">
        </zrickr-main-content>
      </paper-scroll-header-panel>
    </paper-drawer-panel>
  </template>
</dom-module>

<script>
(function() {
  'use strict';

  Polymer({
    is: 'zrickr-app',

    properties: {
      path: {
        type: String,
        value: undefined
      },
      positionDrawer: {
        type: String,
        value: 'left'
      },
      /**
       * Authentication and backend information
       */
      auth: {
        type: Object
      },
      items: {
        type: Array
      }
    },

    //https://www.polymer-project.org/1.0/toolbox/routing
    observers: [
      '_pathChanged(path)',
      '_pageRouteChanged(pageRouteData.page)',
      '_idRouteChanged(idRouteData.id)',
      '_subIdRouteChanged(subIdRouteData.id)'
    ],

    listeners: {
      'drawer-menu-tapped': '_openDrawer',
      'add-item-tapped': '_newItemProcess',
      'add-item': '_addItem',
      'home-tapped': '_viewItems',
      'item-tapped': '_viewItem',
      'view-item-tapped': '_viewItem',
      'edit-item-tapped': '_editItem',
      'delete-item-tapped': '_deleteItem',
      'edit-profile-tapped': '_editProfile',
      'add-object-tapped': '_newObjectProcess',
      'add-object': '_addObject',
      'view-object-tapped': '_viewObject'
    },

    _noSubroute(level) {
      return !this.path.split('/')[level+1];
    },

    _shapePath(...subPaths) {
      this.set('path', '/' + subPaths.join('/') + '/');
    },

    _pathChanged(path) {
      if (this._noSubroute(0)) {
        this._shapePath('items');
      }
      if (!this._noSubroute(3)) {
        this._addMainContent('zrickr-profile', "RUTA NO ENCONTRADA");
        return;
      }
    },

    _pageRouteChanged(page) {
      console.log('pageRouteChanged', page);
      if (this._noSubroute(1)) {
        console.log('pageRouteChanged', "PASA");
        switch (page) {
          case 'items':
            this.$.mainContent.showItems(this.$.drawerContent.primaryCatalogMenuName);
            break;
          case 'profile':
            this._addMainContent('zrickr-profile','User Profile');
            break;
          default:
            //TODO: error page
            this._addMainContent('zrickr-profile', "RUTA NO ENCONTRADA");
        }
      }
      else {
        console.log('pageRouteChanged', "NO PASA");
      }
    },

    _idRouteChanged(id) {
      console.log('idRouteChanged', id);
      if (id && this._noSubroute(2)) {
        console.log('idRouteChanged', "PASA");
        let page = this.pageRouteData.page;
        switch (page) {
          case 'items':
            let itemId = id;
            let itemNamePromise = this.$.collectionHandler.getNameById(itemId);
            itemNamePromise
              .then((itemName) => {
                let zrickrObjectList =
                  this._addMainContent('zrickr-object-list', itemName);
                zrickrObjectList.item = {
                  'id': itemId,
                  'name': itemName
                };
                zrickrObjectList.itemId = itemId;
              })
              .catch(() => {
                this._addMainContent('zrickr-profile', "ITEM NO ENCONTRADO");
              });
            break;
          default:
            //TODO: error page
            this._addMainContent('zrickr-profile', "RUTA NO ENCONTRADA");
        }
      }
      else {
        console.log('idRouteChanged', "NO PASA");
      }
    },

    _subIdRouteChanged(id) {
      console.log('subIdRouteChanged', id);
      if (id && this._noSubroute(3)) {
        console.log('subIdRouteChanged', "PASA");
        let page = this.pageRouteData.page;
        let subPage = this.idRouteData.id;
        switch (page) {
          case 'items':
            let itemName = "HOLA";
            let itemId = subPage;
            let objectId = id;
            let zrickrObjectView =
              this._addMainContent('zrickr-object-view',
                                   itemName + ': ' + objectId);
            zrickrObjectView.item = {
              'id': objectId,
              'itemId': itemId
            };
            break;
          default:
            //TODO: error page
            this._addMainContent('zrickr-profile', "RUTA NO ENCONTRADA");
        }
      }
      else {
        console.log('subIdRouteChanged', "NO PASA");
      }
    },

    attached() {
      let mainPanel = this.$.mainPanel;
      if (this.positionDrawer == 'right') {
        mainPanel.rightDrawer = true;
      }
    },

    /**
     * Add an element to the content of the zrickr-main-content
     * @param {String} elementName Element to append
     * @param {String} headerTitle [description]
     * @param {String} route       [description]
     */
    _addMainContent(elementName, headerTitle) {
      let mainPanel = this.$.mainPanel;
      let container = this.$.mainContent;
      container.removeContent();
      let newContent = document.createElement(elementName);
      newContent.auth = this.auth;
      //newContent.collections = this.items;
      //this.addEventListener("items-changed", (event) => {
      /* TODO:
       *  mirar SET collections en evento items-changed para ir rellenando
       * collections en hijo y DEBOUNCE para esperar unos milisegundos
       * y no hacer el SET cada vez que se meta un item desde firebase
       * sino al final cuando esten metidos todos
       */
      /* newContent.renderList(); //ASI SE CONSIGUE PERO TARDA CON items-changed
       * console.log(newContent.collections, event.detail);
       */
      //});
      container.addContent(newContent, headerTitle);
      mainPanel.closeDrawer();
      return newContent;
    },

    /**
     * Fired when the user taps on menu button
     */
    _openDrawer() {
      let mainPanel = this.$.mainPanel;
      mainPanel.openDrawer();
    },

    _editProfile() {
      this._shapePath('profile');
    },

    _viewItems() {
      this._shapePath('items');
    },

    /**
     * Fires when the user wants to view a item
     */
    _viewItem(event) {
      let item = event.detail;
      let itemId = this.$.collectionHandler.getId(item);
      this._shapePath('items', itemId);
    },

    /**
     * Fired when the user taps on add a new item in drawer. Add
     * the new process of collecion creation
     */
    _newItemProcess() {
      let newCollectionProcess =
        document.createElement('zrickr-collection-new');
      this.$.mainContent.appendChild(newCollectionProcess);
      this.$.mainPanel.closeDrawer();
    },

    /**
     * Fires when the process of creation has finished
     */
    _addItem(event) {
      let item = event.detail;
      this.$.collectionHandler.add(item);
    },

    /**
     * Fires when the user wants to edit a item
     */
    _editItem(event) {
      let item = event.detail;
    },

    /**
     * Fires when the user wants to delete a item
     */
    _deleteItem(event) {
      let item = event.detail;
    },

    /**
     * Fires when the user wants to view and object
     */
    _viewObject(event) {
      let object = event.detail;
      let itemId = object.itemId;
      let itemName = this.$.collectionHandler.getNameById(itemId);
      let objectId = this.$.objectHandler.getId(object);
      this._shapePath('items', itemId, objectId);
    },

    /**
     * Fires when the user wants to add an object on a item
     */
    _newObjectProcess(event) {
      let object = event.detail;
      let itemId = object.itemId;
      let itemName = object.itemName;
      let zrickrObjectNew =
        this._addMainContent('zrickr-object-new',
                             'New ' + itemName + ' object');
      zrickrObjectNew.itemId = itemId;
    },

    /**
     * Fires when the user finish the object creation process
     */
    _addObject(event) {
      let object = event.detail;
      this.$.objectHandler.add(object);
      let itemId = object.itemId;
      let itemName = this.$.collectionHandler.getNameById(itemId);
      let zrickrObjectList =
        this._addMainContent('zrickr-object-list', itemName);
      zrickrObjectList.item = {
        'id': itemId,
        'name': itemName
      };
    }
  });
})();
</script>
