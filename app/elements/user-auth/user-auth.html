<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/firebase-element/firebase-auth.html">

<dom-module id="user-auth">
  <template>
    <firebase-auth id="firebaseAuth"
      user="{{user}}"
      status-known="{{statusKnown}}"
      location="[[location]]"
      provider="{{provider}}"
      on-error="errorHandler"
      on-user-created="userSuccessHandler"
      on-password-changed="userSuccessHandler"
      on-password-reset="userSuccessHandler"
      on-user-removed="userSuccessHandler">
    </firebase-auth>
  </template>
</dom-module>

<script>
  Polymer({
    is: 'user-auth',

    properties: {
      location: {
        type: String,
        value: 'https://zrickr.firebaseio.com',
        notify: true,
        readOnly: true
      },

      provider: {
        type: String,
        value: 'password'
      },

      message: {
        type: String,
        value: ''
      },

      email: {
        type: String,
        value: '',
        notify: true
      },

      password: {
        type: String,
        value: ''
      },

      user: {
        type: Object,
        value: {},
        notify: true
      },

      statusKnown: {
        type: Boolean
      }
    },

    login() {
      let params;
      try {
        params = JSON.parse(this.params);
      } catch (e) {
        params = null;
      }
      if (this.provider == 'password') {
        params = params || {};
        params.email = this.email;
        params.password = this.password;
      }
      this.$.firebaseAuth.login(params);
    },

    logout() {
      this.$.firebaseAuth.logout();
    },

    createUser(e) {
      this.$.firebaseAuth.createUser(this.email, this.password);
    },

    errorHandler(e) {
      this.message = 'Error: ' + e.detail.message;
    },

    userSuccessHandler(e) {
      this.message = e.type + ' success!';
    },

    /*on-password-changed="userSuccessHandler"
    on-password-reset="userSuccessHandler"
    on-user-removed="userSuccessHandler">*/
    changePasswordHandler: function(e) {
      this.$.firebaseAuth.changePassword(this.email, this.password, this.newPassword);
    },

    resetPasswordHandler: function(e) {
      this.$.firebaseAuth.sendPasswordResetEmail(this.email);
    },

    computePasswordHidden: function(provider) {
      return provider !== 'password';
    },

    computeCreateUserDisabled: function(email, password) {
      return !email || !password;
    },

    computeChangePasswordDisabled: function(email, password, newPassword) {
      return !email || !password || !newPassword;
    },

    computeResetPasswordDisabled: function(email, password) {
      return !email || !password;
    },

    computeRemoveUserDisabled: function(email, password) {
      return !email || !password;
    },

    computeLoginHidden: function(statusKnown, user) {
      return !statusKnown || !!user;
    },

    computeLogoutHidden: function(statusKnown, user) {
      return !statusKnown || !user;
    },

    computeLoginStatus: function(statusKnown, user) {
      if (statusKnown && user) {
        return 'Logged in';
      }

      if (statusKnown) {
        return 'Logged out';
      }

      return 'Unknown (checking status...)';
    }
  });
</script>
