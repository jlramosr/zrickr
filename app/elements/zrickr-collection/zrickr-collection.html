<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/firebase-element/firebase-collection.html">

<!--
`<zrickr-collection>` is the main handler of a collection with the basic
methods (add, modify, remove a collection)

@demo demo/index.html
@element zrickr-collection
-->

<dom-module id="zrickr-collection">
  <template>
    <!--<firebase-collection
      location="[[_getLocation(location)]]"
      data="{{collections}}">
   </firebase-collection>-->
  </template>

</dom-module>

<script src="https://www.gstatic.com/firebasejs/live/3.0/firebase.js"></script>


<script>
(function() {
  'use strict';

  Polymer({

    is: "zrickr-collection",

    properties: {
      app: {
        type: Object,
        readonly: true
      },
      subLocation: {
        type: String,
        value: "/",
        readonly: true
      },
      nameCollection: {
        type: String,
        value: "Collection",
        readonly: true
      },
      titleKeyName: {
        type: String,
        value: "name",
        readonly: true
      },
      idKeyName: {
        type: String,
        value: "__firebaseKey__",
        readonly: true
      },
      location: {
        type: String,
        readonly: true
      },
      collections: {
        type: Array,
        value: function() {
          return [];
        },
        notify: true
      },
      loading: {
        type: Boolean,
        value: true,
        notify: true
      },
    },

    ready() {
      let config = {
        apiKey: "AIzaSyAEjGn2rv0MQ9xtha15xHkMvhntP4mM3Kg",
        authDomain: "zrickrdatabase.firebaseapp.com",
        databaseURL: "https://zrickrdatabase.firebaseio.com",
        storageBucket: "zrickrdatabase.appspot.com",
      };
      this.app = firebase.initializeApp(config);
      this.getCollections()
        .then((collections) => {
          this.loading = false;
          this.collections = collections;
        });
    },

    /**
     * Calculate the complete url of the collection backend
     */
    _getLocation() {
      return (this.location + "/" + this.subLocation);
    },

    /**
     * Add a collection
     * @param {object} The collection to add
     */
    add(collection) {
      let ref = this.app.database().ref(this.subLocation);
      ref.push(collection);
      this.collections.push(collection);
    },

    getId(collection) {
      return collection[this.idKeyName];
    },

    getName(collection) {
      return collection[this.titleKeyName];
    },

    getCollection(id) {
      let ref = this.app.database().ref(this.subLocation + id);
      let promise = new Promise((resolve, reject) => {
        ref.once("value", (snapshot) => {
          let collection = snapshot.val();
          if (collection) {
            resolve(collection);
          }
          else {
            reject(this.nameCollection + ' Not Found');
          }
        });
      });
      return promise;
    },

    getCollections() {
      let ref = this.app.database().ref(this.subLocation);
      let promise = new Promise((resolve, reject) => {
        ref.on("value", (snapshot) => {
          let collections = [];
          snapshot.forEach((_collection) => {
            let collection = _collection.val();
            collection[this.idKeyName] = _collection.key;
            collections.push(collection);
          });
          if (this.collections) {
            resolve(collections);
          }
          else {
            reject(this.nameCollection + 's Not Found');
          }
        });
      });
      return promise;
    }
  });
}());
</script>
