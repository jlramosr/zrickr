<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/firebase-element/firebase-auth.html">
<link rel="import" href="../../elements/zrickr-login/zrickr-login.html">
<link rel="import" href="../../elements/zrickr-app/zrickr-app.html">

<dom-module id="zrickr-auth">
  <template>
    <firebase-auth id="firebaseAuth"
      user="{{user}}"
      status-known="{{statusKnown}}"
      location="[[location]]"
      provider="{{provider}}"
      on-error="_errorHandler"
      on-login="_userSuccessHandler"
      on-logout="_userSuccessHandler"
      on-user-created="_userSuccessHandler"
      on-password-changed="_passwordChangedHandler"
      on-password-reset="_passwordResetHandler"
      on-user-removed="_userSuccessHandler">
    </firebase-auth>
  </template>
</dom-module>

<script>
  Polymer({
    is: 'zrickr-auth',

    properties: {
      location: {
        type: String,
        value: 'https://zrickr.firebaseio.com',
        readOnly: true
      },

      provider: {
        type: String,
        value: 'password',
        notify: true,
        readonly: true
      },

      email: {
        type: String,
        value: '',
      },

      password: {
        type: String,
        value: ''
      },

      user: {
        type: Object,
        value: {},
        notify: true,
        observer: '_userChanged'
      },

      statusKnown: {
        type: Boolean
      },

      currentElement: {
        type: Object,
        value: null
      }
    },

    listeners: {
      'logout-tapped': 'logout'
    },

    _userChanged(user) {
      if (this.currentElement) {
        this.currentElement.remove();
        this.currentElement = null;
      }
      if (user) {
        this.currentElement = document.createElement('zrickr-app');
        this.currentElement.user = this.user;
        this.currentElement.location = this.location;
      }
      else {
        this.currentElement = document.createElement('zrickr-login');
        /*document.body.style.backgroundImage = "url('../images/background.jpg')";
        document.body.style.backgroundRepeat = "no-repeat";
        document.body.style.backgroundSize = "100% 100%";*/
      }
    this.appendChild(this.currentElement);
    },

    login() {
      let params;
      try {
        params = JSON.parse(this.params);
      } catch (e) {
        params = null;
      }
      if (this.provider == 'password') {
        params = params || {};
        params.email = this.email;
        params.password = this.password;
      }
      this.$.firebaseAuth.login(params);
    },

    logout() {
      this.$.firebaseAuth.logout();
    },

    createUser() {
      this.$.firebaseAuth.createUser(this.email, this.password);
    },

    changePassword(oldPassword, newPassword) {
      this.$.firebaseAuth.changePassword(this.email, oldPassword, newPassword);
    },

    resetPassword() {
      this.$.firebaseAuth.sendPasswordResetEmail(this.email);
    },

    removeUser() {
      this.$.firebaseAuth.removeUser(this.email, this.password)
    },

    _errorHandler(event) {
      let params = {};
      params.message = "Error: " + event.detail.message;
      params.error = true;
      this.fire('message-opened', params);
    },

    _userSuccessHandler(event) {
      /*let params = {};
      params.message = event.type + " success!";
      params.success = true;
      this.fire('show-message', params);*/
    },

    _passwordResetHandler(event) {
      let params = {};
      params.message = "An email has been sent to " + this.email;
      params.info = true;
      this.fire('message-opened', params);
    },

    _passwordChangedHandler(event) {
      let params = {};
      params.message = "Your password has been changed correctly";
      params.info = true;
      this.fire('message-opened', params);
    },

  });
</script>
